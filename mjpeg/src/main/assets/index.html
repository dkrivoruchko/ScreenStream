<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset=utf-8>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScreenStream</title>
    <link rel="icon" type="image/x-icon" sizes="any" href="/favicon.ico">
    <style>
        body,
        html {
            width: 100%;
            height: 100%;
            margin: 0;
            border: 0;
            overflow: hidden;
            display: block;
            font-family: sans-serif;
            font-size: 16px
        }

        body {
            background-color: BACKGROUND_COLOR
        }

        #connectDiv,
        #pinDiv,
        #blockedDiv,
        #errorDiv {
            min-width: 350px;
            border-radius: 16px;
            color: #eee;
            top: 45%;
            left: 50%;
            padding: 40px 40px 30px;
            transform: translate(-50%, -50%);
            text-align: center;
            position: absolute;
            box-shadow: 0 0 8px 8px rgba(0, 0, 0, .2);
            background-color: #132b42;
        }

        #streamDiv img {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            margin: auto;
            max-height: 100vh;
            max-width: 100%;
        }

        #buttonsDiv {
            visibility: hidden;
            top: 16px;
            left: 16px;
            width: 100%;
            text-align: center;
            position: absolute;
            z-index: 10;
        }

        #pinDiv input {
            background-color: #FFF;
            padding: 4px;
            width: 4em;
            font-family: monospace;
        }

        #pinDiv button {
            background-color: #19769F;
            border-radius: 6px;
            border: none;
            color: white;
            padding: 8px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block
        }

        @media screen and (max-width:850px) {

            #connectDiv,
            #pinDiv,
            #blockedDiv,
            #errorDiv {
                padding: 30px;
                width: 55%
            }
        }

        @media screen and (max-width:650px) {

            #connectDiv,
            #pinDiv,
            #blockedDiv,
            #errorDiv {
                padding: 30px 20px;
                width: 85%
            }
        }

        .loading {
            margin: 20px 0 10px 0;
        }

        .loading span {
            display: inline-block;
            vertical-align: middle;
            width: .6em;
            height: .6em;
            margin: .19em;
            background: #fff;
            border-radius: .6em;
            animation: loading 1s infinite alternate
        }

        .loading span:nth-of-type(2) {
            background: #fff;
            animation-delay: .2s
        }

        .loading span:nth-of-type(3) {
            background: #fff;
            animation-delay: .4s
        }

        .loading span:nth-of-type(4) {
            background: #fff;
            animation-delay: .6s
        }

        .loading span:nth-of-type(5) {
            background: #fff;
            animation-delay: .8s
        }

        .loading span:nth-of-type(6) {
            background: #fff;
            animation-delay: 1s
        }

        .loading span:nth-of-type(7) {
            background: #fff;
            animation-delay: 1.2s
        }

        @keyframes loading {
            0% {
                opacity: 0
            }

            100% {
                opacity: 1
            }
        }
    </style>
    <script type="text/javascript" src="https://www.datadoghq-browser-agent.com/us1/v4/datadog-logs.js" crossorigin="anonymous"></script>
    <script>
        window.DD_LOGS &&
            DD_LOGS.init({
                clientToken: "pub26fc6543f9239240ed8ae545593f921f",
                site: "datadoghq.com",
                forwardConsoleLogs: ["info", "warn", "error"],
                forwardReports: "all",
                service: '%DD_SERVICE%',
            });
        window.DD_LOGS && DD_LOGS.logger.setHandler(DD_HANDLER);
        window.DD_LOGS && DD_LOGS.setGlobalContextProperty('version', '%APP_VERSION%');
    </script>
</head>

<body>
    <div id="connectDiv">
        <img src="logo.png" height="256" width="256" />
        <p style="font-weight:500">%CONNECTING%</p>
        <div class="loading">
            <span></span>
            <span></span>
            <span></span>
            <span></span>
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>

    <div id="streamDiv"><img id="stream" /></div>

    <div id="buttonsDiv">
        <input type="image" id="fullscreen" src="data:image/webp;base64,UklGRmIAAABXRUJQVlA4TFUAAAAvI8AIECcw//M//wKBFG52gQ4Ag1UkSa2WIAAJ1OIABWn9qyK+8B/Rf6Nt2ySorN2+wP8NJC0QSZqRKMkDRZK9IY0hL/hCgV/5lVudfeGZ3x19/PcCAA==" onclick="toggleFullscreen()" />
        <input type="image" src="data:image/webp;base64,UklGRqAAAABXRUJQVlA4TJMAAAAvI8AIEHU4jiTJUfDf6ULDDOpbMRE9RLAJALZJ5x0HuWqgf8+JEZDAy1kZERIX0QAGerImwJ+fgH6AxD4z6sxMbnFA+Pv+/EnUJPnfERjoEATsEC5ihzBZOoSbrUPCQHcIhO8QGOgQBHwTMGAdhLdu0ZZxs3q9gjnWcRKtQ0DrYMA6CG8dAX1Q95MZu6vu7ubW7w4A" onclick="toggleStartStop()" />
    </div>

    <div id="pinDiv" style="visibility: hidden;">
        <img src="logo.png" height="256" width="256" />
        <p>%STREAM_REQUIRE_PIN%</p>
        <form action="" id="pinForm" autocomplete="off">
            <label for="pin">%ENTER_PIN%</label>
            <input id="pin" autofocus maxlength="6" pattern="[0-9]{4,6}" required type="password" autocomplete="off">
            <button id="sendPin" type="submit">%SUBMIT_PIN%</button>
        </form>
        <p id="pinWrongMsg" style="color:red;font-weight:700">%WRONG_PIN_MESSAGE%</p>
    </div>

    <div id="blockedDiv" style="visibility: hidden;">
        <img src="logo.png" height="256" width="256" />
        <p style=color:red;font-weight:600>%ADDRESS_BLOCKED%</p>
    </div>

    <div id="errorDiv" style="visibility: hidden;">
        <img src="logo.png" height="256" width="256" />
        <p style=color:red;font-weight:600>%ERROR%</p>
    </div>

    <script type="text/javascript" src="/script.js"></script>
    <script>
        "use strict";
        const clientId = RandomString(16);
        window.DD_LOGS && DD_LOGS.setGlobalContextProperty('clientId', clientId);

        var enableButtons = ENABLE_BUTTONS;
        const buttonsDiv = document.getElementById('buttonsDiv')
        if (enableButtons) buttonsDiv.style.visibility = 'visible';
        const buttonsHideFunction = () => { buttonsDiv.style.visibility = 'hidden'; }
        var hideTimeout = setTimeout(buttonsHideFunction, 1500);

        window.onmousemove = () => {
            if (!enableButtons) return
            buttonsDiv.style.visibility = 'visible';
            clearTimeout(hideTimeout)
            hideTimeout = setTimeout(buttonsHideFunction, 1000);
        }

        function isFullscreen() {
            return document.webkitIsFullScreen || document.mozFullScreen || false;
        }

        const fullscreenInput = document.getElementById("fullscreen");
        function fullScreenHandler() {
            if (isFullscreen()) fullscreenInput.src = "data:image/webp;base64,UklGRkoAAABXRUJQVlA4TD4AAAAvI8AIEBcw//M//wKCoudMD/gICtq2kTwQR2IoDsSBnIb0PgAR/Z8AHxwWkOrY7FQdW56dnapjD6k4NiwfBA==";
            else fullscreenInput.src = "data:image/webp;base64,UklGRmIAAABXRUJQVlA4TFUAAAAvI8AIECcw//M//wKBFG52gQ4Ag1UkSa2WIAAJ1OIABWn9qyK+8B/Rf6Nt2ySorN2+wP8NJC0QSZqRKMkDRZK9IY0hL/hCgV/5lVudfeGZ3x19/PcCAA==";
        }

        document.addEventListener("fullscreenchange", fullScreenHandler);
        document.addEventListener("webkitfullscreenchange", fullScreenHandler);
        document.addEventListener("mozfullscreenchange", fullScreenHandler);
        document.addEventListener("MSFullscreenChange", fullScreenHandler);

        function fullScreen(element) {
            if (element.requestFullscreen) element.requestFullscreen(); else if (element.webkitrequestFullscreen) element.webkitRequestFullscreen(); else if (element.mozRequestFullscreen) element.mozRequestFullScreen();
        }

        function fullScreenCancel() {
            if (document.requestFullscreen) document.requestFullscreen(); else if (document.webkitRequestFullscreen) document.webkitRequestFullscreen(); else if (document.mozRequestFullscreen) document.mozRequestFullScreen();
        }

        function toggleFullscreen() {
            isFullscreen() ? fullScreenCancel() : fullScreen(document.documentElement);
        }

        function toggleStartStop() {
            const xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", window.location.origin + "/start-stop", true);
            xmlHttp.send(null);
        }

        const streamDiv = document.getElementById("streamDiv");
        const stream = document.getElementById("stream");
        const connectDiv = document.getElementById("connectDiv");
        const pinDiv = document.getElementById("pinDiv");
        const pin = document.getElementById("pin");
        const sendPin = document.getElementById("sendPin");
        const pinWrongMsg = document.getElementById("pinWrongMsg");
        const blockedDiv = document.getElementById("blockedDiv");
        const errorDiv = document.getElementById("errorDiv");

        sendPin.addEventListener('click', (e) => {
            e.preventDefault();
            const pinHash = SHA256(clientId + pin.value);
            if (websocket) websocket.send(JSON.stringify({ type: "PIN", data: pinHash }));
        });

        var websocket = null;
        var fallbackMJPEGCounter = 0;
        var fallbackMJPEG = null;
        var showStreamTimeoutId = null;

        function connect() {
            connectDiv.style.visibility = 'visible';
            pinDiv.style.visibility = 'hidden';
            blockedDiv.style.visibility = 'hidden';
            pinWrongMsg.style.visibility = "inherit";
            streamDiv.style.visibility = 'hidden';
            errorDiv.style.visibility = 'hidden';
            stream.src = '';

            websocket = new WebsocketHeartbeat({ url: `ws://${window.location.host}/socket?clientId=${clientId}` });

            websocket.onopen = () => {
                websocket.send(JSON.stringify({ type: "CONNECT" }));
                connectDiv.style.visibility = 'hidden';
            };

            websocket.onreconnect = () => {
                window.DD_LOGS && DD_LOGS.logger.debug("reConnect");

                connectDiv.style.visibility = 'visible';
                pinDiv.style.visibility = 'hidden';
                blockedDiv.style.visibility = 'hidden';
                pinWrongMsg.style.visibility = "inherit";
                streamDiv.style.visibility = 'hidden';
                errorDiv.style.visibility = 'hidden';
                stream.src = '';

                fallbackMJPEGCounter = 0;
                clearTimeout(showStreamTimeoutId);
            };

            websocket.onmessage = (msg) => {
                const message = JSON.parse(msg.data);
                if (message.type === "HEARTBEAT") return;

                window.DD_LOGS && DD_LOGS.logger.debug("websocket.onmessage", { message: msg.data });

                if (message.type === "STREAM_ADDRESS") {
                    pinDiv.style.visibility = 'hidden';
                    blockedDiv.style.visibility = 'hidden';
                    pinWrongMsg.style.visibility = "inherit";
                    showStream(message.data + `?clientId=${clientId}`);
                    return;
                }

                if (message.type === "UNAUTHORIZED") {
                    if (message.data === "ADDRESS_BLOCKED") {
                        pinDiv.style.visibility = 'hidden';
                        blockedDiv.style.visibility = 'visible';
                        pinWrongMsg.style.visibility = "inherit";
                        return;
                    }

                    pinDiv.style.visibility = 'visible';
                    blockedDiv.style.visibility = 'hidden';

                    if (message.data === "WRONG_PIN") {
                        pin.value = "";
                        pinWrongMsg.style.visibility = 'visible';
                    } else {
                        pinWrongMsg.style.visibility = 'hidden';
                        if (pin.value) sendPin.click();
                    }
                    return;
                }

                if (message.type === "RELOAD") {
                    location.reload();
                    return;
                }

                if (message.type === "SETTINGS") {
                    document.body.style.backgroundColor = message.data.backColor;

                    if (enableButtons != message.data.enableButtons) {
                        enableButtons = message.data.enableButtons;
                        if (enableButtons) {
                            buttonsDiv.style.visibility = 'visible';
                            hideTimeout = setTimeout(buttonsHideFunction, 1500);
                        } else {
                            clearTimeout(hideTimeout);
                            buttonsDiv.style.visibility = 'hidden';
                        }
                    }
                    return;
                }

                window.DD_LOGS && DD_LOGS.logger.error("websocket.onmessage. Unknown data:", { message: e.data });
            };
        };

        function showStream(url) {
            window.DD_LOGS && DD_LOGS.logger.debug("showStream", { data: url });

            streamDiv.style.visibility = 'hidden';
            stream.src = '';

            clearTimeout(showStreamTimeoutId);
            if (fallbackMJPEG) fallbackMJPEG.stop();
            fallbackMJPEG = null;

            if (fallbackMJPEGCounter > 2) {
                window.DD_LOGS && DD_LOGS.logger.debug("showStream: Load via fallback", { data: url });

                streamDiv.style.visibility = 'visible';
                fallbackMJPEG = new MJPEG_JS({ img: stream, url });
                fallbackMJPEG.onerror = (error) => {
                    streamDiv.style.visibility = 'hidden';
                    window.DD_LOGS && DD_LOGS.logger.error("fallback", { data: error.message });
                    errorDiv.style.visibility = 'visible';
                    fallbackMJPEG = null;
                };
                fallbackMJPEG.load();
            } else {
                new Promise((resolve, reject) => {
                    window.DD_LOGS && DD_LOGS.logger.debug("showStream: Load via default", { data: url });
                    stream.onload = () => { stream.onload = null; stream.onerror = null; resolve(); }
                    stream.onerror = (e) => { stream.onerror = null; stream.onload = null; reject(e); }
                    stream.src = url;
                }).then(() => {
                    fallbackMJPEGCounter = 0;
                    streamDiv.style.visibility = 'visible';
                }).catch((error) => {
                    window.DD_LOGS && DD_LOGS.logger.error("showStream: Default error", { data: error });
                    fallbackMJPEGCounter++;
                    showStreamTimeoutId = setTimeout(() => showStream(url), 150);
                });
            }
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', connect);
        } else {
            connect();
        };

        // setTimeout(() => { if (!stream.complete) streamFallback() }, 2000);
        // function streamFallback() {
        //     const baseurl = url.split(".mjpeg")[0];
        //     setInterval(() => { stream.src = baseurl + ".jpeg?t=" + Math.random() }, 500);
        // }
    </script>
</body>

</html>